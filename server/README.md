# Server

This is the backend of the full-stack TypeScript template, built with Hapi, GraphQL Yoga, and GraphQL Modules.

## Scripts

- `npm run dev` – Runs `ts-node-dev` and GraphQL Codegen in watch mode.
- `npm run codegen` – Generates GraphQL resolver types and skeletons.
- `npm run build` – Compiles TypeScript to JavaScript (`tsc`).
- `npm run start` – Runs the built Node.js module.

## GraphQL Codegen
The server uses GraphQL Codegen to generate type-safe resolvers. Resolver files are initially empty, allowing developers to implement them manually while maintaining type safety.

## GraphQL Modules

GraphQL Modules is used for structuring the backend. Modules are created using `createModule()`:

```ts
import { createModule } from "graphql-modules";
import { resolvers } from "./resolvers.generated";
import { typeDefs } from "./typeDefs.generated";

export const subscription = createModule({
  id: "subscription",
  typeDefs: [typeDefs],
  resolvers: resolvers,
});
```

The resolvers and typeDefs are auto-generated by GraphQL Codegen. Modules can then be registered in `createApplication()`:

```ts
export default function createApplication() {
  const application = createGraphQLModulesApplication({
    modules: [baseSchema, user, subscription],
    providers: [],
  });

  return [application, application.schema] as const;
}
```

For standard HTTP routes, DI values can be accessed via `app.injector.get()`:

```ts
const db = application.injector.get(Db);
const stripe = application.injector.get(Stripe);

// example providing the value of `Db` which is typed to `initSupertokens()` so we can register a post-login callback
initSupertokens(db);
```

To modify the GraphQL Context type, update `context.ts` and the Yoga context function in `index.ts`:

```ts
const yoga = createYoga<ServerContext, Context>({
  plugins: [useGraphQLModules(application)],
  context: async ({ req, h }) => {
    try {
      const session = await Session.getSession(req, h, { sessionRequired: false });
      return { userId: session ? session.getUserId() : undefined } as Context;
    } catch (err) {
      if (Session.Error.isErrorFromSuperTokens(err)) {
        throw new GraphQLError("Session related error", {
          extensions: { code: "UNAUTHENTICATED", http: { status: 401 } },
        });
      }
      throw err;
    }
  },
});
```

For more details, see the [GraphQL Modules documentation](https://the-guild.dev/graphql/modules).
